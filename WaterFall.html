<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Waterfall-lazyload</title>
  <link rel="shortcut icon" href="favicon.ico">
  <style media="screen" type="text/css">
    body {
      margin: 0px;
      padding: 0px;
    }

    .waterfall {
      position: absolute;
      margin: 25px 0 0 0;
      /*width: 1100px;*/
      left: 50%;
      /*margin-left: -550px;*/
    }

    .box {
      padding: 15px 0px 0px 20px;
      float: left;
      /*margin:  0 0 0 -20px;*/
    }

    .box img {
      width: 200px;
      height: auto;
      opacity: 0.2;
    }
  </style>
</head>

<body>
  <div class="waterfall">
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww4.sinaimg.cn/large/006y8mN6gw1fa5obmqrmvj305k05k3yh.jpg" alt="">
    </div>
    <div class="box">
      <img src="rolling.gif" data-src="http://ww1.sinaimg.cn/large/006y8mN6gw1fa7kaed2hpj30sg0l9q54.jpg" alt="">
    </div>
  </div>




  <script type="text/javascript">
    //选中所有的 img 和 box
    var imgs = document.getElementsByTagName("img");
    var boxs = document.getElementsByClassName("box");
    var winW = document.documentElement.clientWidth;
    var water = document.getElementsByClassName('waterfall');
    //利用offsetWidth获取box元素的宽度，此宽度是元素带上边框的宽度
    var boxsW = boxs[0].offsetWidth;
    var cols = parseInt(winW / boxsW - 1); //获取可存放的列数，parseInt取整
    var waterW = cols * boxsW; //获取居中所需要的宽度
    water[0].style.width = waterW + "px";
    water[0].style.marginLeft = -waterW / 2 + "px";
    //当页面加载完成时触发
    window.onload = function() {
      loadImg(imgs);
      window.onscroll = function() {
        changeSize();
        loadImg(imgs);
      }
    }

    //当浏览器窗口改变时触发
    window.onresize = function() {
changeSize();
loadImg(imgs);
    }

// 实时获取参数
function changeSize(){
  var winW = document.documentElement.clientWidth;
  var cols = parseInt(winW / boxsW - 1); //获取可存放的列数，parseInt取整
  var waterW = cols * boxsW; //获取居中所需要的宽度
  water[0].style.width = waterW + "px";
  water[0].style.marginLeft = -waterW / 2 + "px";
  loadImg(imgs);
  waterfall(boxs, cols, boxsW);
}

    //瀑布流布局
    function waterfall(ele, col, eleW) {
      var arrH = [];
      for (var i = 0; i < ele.length; i++) {
        if (i < col) {
          arrH.push(ele[i].offsetHeight); //数组里添加元素的高度
        } else {
          var minH = Math.min.apply(null, arrH); //找出最小的高度的图片
          var index = arrH.indexOf(minH); //获取最小高度图片的下标
          ele[i].style.position = "absolute";
          ele[i].style.top = minH + 'px'; //top left 是没有px的
          ele[i].style.left = index * eleW + "px";
          arrH[index] += ele[i].offsetHeight; //这个下标的元素的高度改变为加上新元素的高度
        }
      }
    }


    //懒加载图片
    function loadImg(imgs) {
      for (var i = 0; i < imgs.length; i++) {
        //getBoundingClientRect().top;该方法返回元素到页面顶部的距离
        if (imgs[i].getBoundingClientRect().top < document.documentElement.clientHeight - 250 && !imgs[i].isLoad) {
          imgs[i].isLoad = true;
          if (imgs[i].dataset) {
            changeSrc(imgs[i], imgs[i].dataset.src);
          } else {
            changeSrc(imgs[i], imgs[i].getAttribute("data-src"));
          }
          imgs[i].style.cssText = "transition: opacity 1s; opacity: 1; "
        }
      }
    }

    //图片地址赋值
    function changeSrc(obj, Src) {
      obj.src = Src;
      obj.removeAttribute("data-src");
      changeSize();
      waterfall(boxs, cols, boxsW);
    }
  </script>





</body>

</html>
