<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>MQTT 客户端 | 订阅者 | 订阅者</title>
  <style>
  #app {
    margin: 0 auto;
  }
    .success {
    background: green;
    color: #fff;
  }
  </style>
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

  <div id="app">
    <div class="row-box">
      <span>域名:</span>
      <input v-model="host" placeholder="...">
    </div>
    <div class="row-box">
      <span>端口:</span>
      <input v-model="port" placeholder="...">
    </div>
    <div class="row-box">
      <span>客户端ID:</span>
      <input v-model="client_id" placeholder="...">
    </div>
    <div class="row-box">
      <span>订阅的主题:</span>
      <input v-model="topic" placeholder="...">
    </div>


    <div v-if="connect_success">
      <button type="button" name="连接服务器" @click="disconnect">断开服务器</button>
    </div>
    <div v-else>
      <button type="button" name="连接服务器" @click="connectClient">连接服务器</button>
    </div>

    <span>state : {{state}}</span>

    <div class="row-box">
      <span>发布的消息:</span>
      <input v-model="public_message" placeholder="...">
      <span>目标主题:</span>
      <input v-model="to_topic" placeholder="...">
    </div>


    <div v-if="connect_success">
      <div v-if="is_subscribe">
        <button type="button" name="订阅" @click="unsubscribe">取消订阅</button>
      </div>
      <div v-else>
        <button type="button" name="订阅" @click="subscribe">订阅</button>
      </div>
      <button type="button" name="发布消息" @click="send">发布消息</button>
    </div>
    <div v-else>
      <button type="button" name="订阅" @click="subscribe" disabled>订阅</button>
      <button type="button" name="发布消息" @click="send" disabled>发布消息</button>
    </div>

    <span>收到的消息: {{ res_msg }}</span>


  </div>

  <script type="text/javascript">
    window.onload = function() {
      var app = new Vue({
        el: '#app',
        data: {
          client: '', // 客户端实例
          host: '', // 域名
          port: '', // 端口号
          client_id: '', // 客户端id
          topic: '', // 订阅的主题
          to_topic: '', // 目标主题
          public_message: '', // 发布的消息
          connect_success: false, // 连接成功与否
          state: '未连接', // 连接状态
          is_subscribe: false, /// 订阅状态
          res_msg: '', // 收到的消息
        },
        methods: {
          // 取消订阅
          unsubscribe() {
            this.client.unsubscribe(this.topic, {
              onSuccess: () => {
                this.is_subscribe = false;
              }
            });
          },
          // 断开连接
          disconnect() {
            this.client.disconnect();
            this.state = '未连接';
            this.connect_success = false;
          },
          // 发布消息
          send() {
            let message = new Paho.MQTT.Message(this.public_message);
            message.destinationName = this.to_topic;
            this.client.send(message);
          },
          // 订阅
          subscribe() {
            this.client.subscribe(this.topic, {
              onSuccess: () => {
                this.is_subscribe = true;
              }
            });
          },
          // 连接服务器
          connectClient() {
            this.state = '正在连接';
            console.log('host', this.host);
            console.log('port', this.port);
            console.log('client_id', this.client_id);
            if (!this.host || !this.port) return alert('域名、端口必填');
            // Create a client instance
            this.client = new Paho.MQTT.Client(this.host, Number(this.port), this.client_id);


            // set callback handlers
            //  连接失败时候
            this.client.onConnectionLost = (responseObject) => {
              if (responseObject.errorCode !== 0) {
                alert("onConnectionLost:" + responseObject.errorMessage);
              }
            };
            // 接受发布的消息
            this.client.onMessageArrived = (message) => {
              this.res_msg = message.payloadString;
            };

            // connect the client
            this.client.connect({
              // called when the client connects
              onSuccess: () => {
                this.state = '连接成功';
                this.connect_success = true;
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                console.log(this);
              }
            });

          }
        },
        created: function() {
          console.log(this);
        }
      });
    }
  </script>
</body>

</html>
